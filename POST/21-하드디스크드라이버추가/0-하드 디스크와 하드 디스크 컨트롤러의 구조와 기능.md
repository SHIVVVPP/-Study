# 하드 디스크와 하드 디스크 컨트롤러의 기능

## 하드 디스크의 구조

하드 디스크는 플로피 디스크와 마찬가지로 디스크(또는 Platter)를 저장 매체로 사용하며,<br>고밀도의 디스크 여러 장이 겹쳐진 원통 형태로 구성된다.

각  디스크는 양면(Head)으로 기록할 수 있으며, 디스크마다 섹터 수와 트랙 수는 모두 같다.

따라서 디스크를 여러 장 수직으로 쌓으면 디스크의 트랙이 같은 축에 위치하여 원통처럼 되며,<br>이러한 모습 때문에 같은 축에 위치하는 트랙을 실린더(Cylinder)라고 부른다.

<hr>

하드 디스크는 디스크를 직접 제어해 작업을 처리하므로 스핀들 모터(Spindle Motor), 액추에이터(Actuator),<br>액세스 암(Access Arm) 등이 있다.

스핀들 모터는 디스크를 회전시키며, 액추에이터는 접근할 섹터나 실린더로 액세스 암을 이동시킨다.

액세스 암의 끝에는 헤드가 존재하며 헤드 아래에 위치하는 영역의 정보를 읽고 쓴다.

우리가 하드 디스크의 파일을 읽고 쓰거나 삭제하면 하드 디스크는 액추에이터와 스핀들 모터 등을 움직여 순식간에 해당 위치로 이동한 뒤에 작업을 수행한다.

<hr>

## CHS 어드레스 방식과 LBA 어드레스 방식

하드웨어 입장에서는 디스크의 어드레스를 실린더, 헤드, 섹터로 나타내는 것이 좋지만<br>소프트웨어 입장에서는 0번 섹터부터 마지막 섹터까지 연속된 섹터 번호(논리적인 섹터 번호)로 접근하는 것이 훨씬 더 편리하다.

결국 논리적인 섹터 번호로 접근하려면 하드 디스크가 물리적으로 헤더, 실린더, 섹터로 구성되므로 디스크 구성에 맞추어 디스크 어드레스로 변환하는 작업이 필요하다.

이처럼 논리적인 섹터 어드레스를 실린더, 헤드, 섹터 값으로 변환해서 디스크 어드레스를 지정하는 방식을 CHS(Cylinder, Head, Sector) 어드레스 방식이라고 한다.

CHS 어드레스 방식은 섹터-> 헤드-> 실린더의 순서로 증가시키며 논리적인 섹터 번호를 할당한다.

<hr>

CHS 어드레스 방식과 달리 하드 디스크의 구성과 관계 없이 논리적인 섹터 번호를 지정하는 방식을 LBA(Logical Block Addressing) 어드레스 방식이라고 한다. LBA 방식의 가장 큰 장점은 디스크의 구성에  구애받지 않고 논리적인 어드레스로 섹터에 접근할 수 있다는 것이다.

<hr>

## 하드 디스크 컨트롤러, I/O포트, 레지스터

하드 디스크 컨트롤러는 다른 컨트롤러와 마찬가지로 PC 내부 버스와 포트 I/O 방식으로 연결되어 있으며,<br>사용할 수 있는 PATA 포트는 최대 두 개이다.

포트 I/O 어드레스는 첫 번째 PATA 포트가 0x1F0~0x1F7과 0x3F6을 사용하며,<br>두번째 PATA 포트가 0x170~0x177과 0x376을 사용한다.

각 PATA 포트는 마스터와 슬레이브로 두 개의 하드 디스크를 연결할 수 있으나 PC에 연결할 수 있는 하드디스크는 최대 4개이다.

![image](https://user-images.githubusercontent.com/34773827/62114185-158dfc80-b2f1-11e9-930a-763a39c0dbb0.png)

<hr>

### 커맨드 레지스터와 데이터 레지스터

커맨드 레지스터는 하드 디스크로 전송할 커맨드를 저장하는 레지스터이다.

하드디스크느느 커맨드를 전송하는 순간 다른 레지스터가 모두 설정되었다고 가정하고 작업을 시작한다.

따라서 커맨드 레지스터는 커맨드 수행에 필요한 준비가 끝난 뒤에 가장 마지막에 설정한다.

커맨드 레지스터의 크기는 1바이트이며, 우리가 사용할 커맨드는 다음과 같다.

- 0x20

  읽기

  하드 디스크의 특정 섹터 부터 섹터 수 레지스터에 저장된 값만큼 읽는다.

  섹터를 읽는 도중 문제가 발생하면 일정한 횟수만큼 재시도

  재시도 후에도 문제가 발생하면 에러를 반환

  필요한 레지스터 - SC, SN, CY, DH

- 0x30

  쓰기

  하드 디스크의 특정 섹터부터 섹터 수 레지스터에 저장된 값만큼 쓴다.

  쓰는 도중 문제가 발생하면 읽기와 같은 방식으로 재시도 수행 후, 에러를 반환한다.

  필요한 레지스터 - SC, SN, CY, DH

- 0xEC

  드라이브 인식

  하드 디스크의 정보를 읽는다.

  필요한 레지스터 - DH

> SC : 섹터 수 레지스터 SN : 섹터 번호 레지스터 DH : 드라이브/헤드 레지스터



