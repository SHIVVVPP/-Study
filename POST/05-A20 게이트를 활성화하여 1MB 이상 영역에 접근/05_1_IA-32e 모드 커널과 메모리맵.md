# IA-32e 모드 커널과 메모리 맵

이번 장에서는 IA-32e 모드 커널을 실행하기 위한 준비 작업으로
PC에 설치된 메모리가 64MB 이상인지 검사하고
**IA-32e 모드 커널이 위치할 영역을 모두 0으로 초기화 하는 작업을 수행한다.**



#### 왜 1MB 이상 영역에 접근해야 하는가?

부트 로더에 의해 커널 이미지가 메모리에 로딩되는 어드레스는 0x10000이다.

만약 1MB 이하의 어드레스 중에서
 비디오 메모리가 위치하는 0xA0000 이하를 커널 공간으로 사용한다고 가정하면,
 보호 모드 커널과 IA-32e 모드 커널의 최대 크기는 0xA0000 - 0x10000이 되어 576KB 정도가 된다.

커널 이미지(보호 모드 커널과 IA-32e 모드 커널 포함)에는 초기화 되지 않은 영역(.bss 섹션)이 포함되지 않으므로,
커널 이미지의 크기로 환산하면 이보다 더 작은 크기여야 한다.

> 지금은 문제가 되지 않지만, 
> 이후 멀티태스킹과 파일 시스템과 같은 기능이 추가되어 커널이 커진다면, 576KB의 공간이 부족할 수 있다.

 우리가 만드는 OS에서는 이런 문제를 해결하기 위해
커널 이미지를 모두 0x10000 어드레스에 복사하되, 
덩치가 큰 IA-32e 모드 커널은 2MB의 어드레스로 복사하여, 2MB ~ 6MB의 영역을 별도로 할당한다.

따라서 IA-32e 모드의 커널 영역은 모든 섹션을 포함하여 총 4MB의 크기가 된다.



< MINT64 OS의 메모리 맵 >

![image](https://user-images.githubusercontent.com/34773827/60808356-0d93de80-a1c3-11e9-8dba-ea6f4b482a57.png)

<hr>



#### 왜 IA-32e 모드 커널이 위치할 영역을 0으로 초기화할까?

미리 초기화 하는 이유는 IA-32e 커널 이미지가 초기화 되지 않은 영역을 포함하고 있지 않기 때문이다.

> 비록 커널은 초기화 되지 않은 영역을 사용하지만, 
> 커널 이미지에는 초기화 되지 않은 영역이 제외되어 있다.
>
> 따라서 커널 이미지를 옮길 때에도 이 영역은 해당되지 않다.

이미지를 옮길 영역을 미리 0으로 초기화 하지 않는다면 어떤 임의의 값이 들어 있을 것이다.

이러한 상태로 IA-32e 모드 커널이 실행되면 0으로 참조되어야 할 변수들이 0이 아닌 값으로 설정되어,
루프 상태를 빠져 나오지 못한다던지, 잘못된 조건문이 실행된다든지 하는 문제가 생길 수 있다.

이러한 사태를 방지하기 위해 먼저 0으로 초기화 하는 것이다.



<hr>

