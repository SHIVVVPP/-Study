# 선형 주소와 4단계 페이징 기법

2MB 페이지를 사용하는 페이징은 4KB 페이지를 사용하는 5단계 페이징 기법과 크게 다르지 않다.

차이점은 페이지 테이블이 사라지고 페이지 디렉터리가 직접 해당 페이지의 시작 어드레스를 가리킨다는 점이다.

<hr>

< IA-32e 모드의 4단계 페이징과 어드레스 변환 과정 >

![image](https://user-images.githubusercontent.com/34773827/60899809-16111580-a2a6-11e9-949d-4cb279d2caf4.png)

**페이징에 사용하는 각 테이블** 은 
512(2의 9승)개의 엔트리로 구성되며, 다음 레벨에서 사용할 테이블의 기준 주소 (Base Address)를 포함한다.

**가장 마지막 레벨인 페이지 디렉터리의 엔트리** 는
2MB 페이지의 기준 주소를 포함한다.

그림과 같이 **선형 주소에 9비트씩 할당된 영역** 은
해당 테이블 내의 엔트리 오프셋을 나타내며, 
이를 통해 최종 엔트리와 테이블을 찾아 실제 물리 주소로 변환한다.

**선형주소를 실제 물리 주소로 변환하려면**

1. PML4 엔트리
2. 페이지 디렉터리 포인터 엔트리
3. 디렉터리 엔트리

순으로 진행하여 2MB 페이지의 기준 주소를 찾은 다음,
기준 주소에 선형 주소의 하위 21비트 오프셋을 더하면 구할 수 있다.

<hr>

위 그림에서 볼 수 있듯이 **4단계 페이징 기법** 을 사용하려면

- **페이지 맵 레벨 4 테이블 (PML4 Table)**
- **페이지 디렉터리 포인터 테이블**
- **페이지 디렉터리**

등 세 가지 자료구조를 생성해야 한다.

각 테이블은 8바이트 크기의 엔트리로 구성되며,
각 엔트리는 다음 레벨 테이블의 기준 주소 외에 다양한 필드를 포함한다.

<hr>

< 페이지 테이블을 구성하는 엔트리의 구조>

![image](https://user-images.githubusercontent.com/34773827/60902864-4d35f580-a2ab-11e9-9bf8-08c090318751.png)

<hr>

< 페이지 테이블을 구성하는 엔트리의 각 필드와 의미 >

- **EXB**
  - Execute-Disable 비트의 약자로 관련된 페이지를 데이터 전용으로 설정하는 것을 의미한다.
  - 1로 설정하면 해당 페이지는 데이터 전용으로 설정되며,
    해당 영역에서 코드를 실행하면 페이지 폴트 예외가 발생한다.
  - 0으로 설정하면 제약 사항이 없다.
  - IA32_EFER 레지스터의 NXE 비트를 1로 설정할 경우 유효하다.
- **Avail**
  - Available의 약자로 OS에서 임의의 용도로 사용할 수 있는 영역을 의미한다.
  - 임의의 용도로 사용할 수 있다.
- **기준주소 ( Base Address )**
  - 다음 레벨 테이블 또는 페이지의 기준 주소를 의미한다.
- **A**
  - Accessed의 약자로 해당 페이지가 접근(읽기 또는 쓰기)되었음을 의미한다.
  - 프로세서가 페이지를 감시하여 접근이 있으면 해당 비트를 설정한다.
  - 1로 설정되면 접근 되었음을 나타내고, 0으로 설정되면 접근되지 않았음을 나타낸다.
- **PCD**
  - Page-Level Cache Disable의 약자로 해당 페이지의 캐시 활성화 여부를 의미한다.
  - CR0 레지스터의 CD 비트가 1로 설정되어 전체 캐시가 비활성된 경우, PCD 비트는 무시된다.
  - 1로  설정하면 해당 페이지의 캐시를 비활성화하며, 0으로 설정하면 해당 페이지의 캐시를 활성화한다.
- **PWT**
  - Page-Level  Write-Through의 약자로 해당 페이지의 캐시 정책을 의미한다.
  - PCD 비트와 마찬가지로, CR0 레지스터의 CD 비트가 1로 설정되어 전체 캐시가 비활성화된 경우
    PWT 비트는 무시된다.
  - 1로 설정하면 해당 페이지는  Write-Through 정책이 적용되며, 
    0으로 설정하면 Write-Back 정책이 적용된다.
- **U/S**
  - User/Supervisor의 약자로 해당 페이지의 권한을 의미한다.
  - 1로 설정하면 유저 레벨 권한(Ring 3)임을 나타내며, 모든 레벨에서 해당 페이지에 접근할 수 있다.
  - 0으로 설정하면 특권 레벨 권한(Ring 0~2)을 나타내며, 
    유저 레벨에서 해당 페이지에 접근하면 페이지 폴트 예외가 발생한다.
- **R/W**
  - User/Write의 약자로 해당 페이지의 읽기/쓰기 정책을 의미한다.
  - 1로 설정하면 읽기/쓰기 모두 가능하며,
  - 0으로 설정하면 읽기만 가능하며, 쓰기를 시도하면 페이지 폴트 예외가 발생한다.
- **P**
  - Present의 약자로 해당 엔트리가 유효함을 의미한다.
  - 1로 설정하면 유효함을 나타내며, 0으로 설정하면 유효하지 않음을 나타낸다.
  - 0으로 설정된 페이지에 접근하면 페이지 폴트 예외가 발생한다.
- **PAT**
  - Page Attribute Table Index의 약자로 PAT 선택에 사용되는 최상위 비트를 의미한다.
  - 프로세서가 PAT를 지원할 경우 PAT, PCD, PWT 3비트를 사용하여 PAT를 선택한다.
  - 프로세서가 PAT를 지원하지 않으면 0으로 예약된다.
- **G**
  - Global의 약자로 CR3 레지스터의 값이 바뀌더라도 
    해당 페이지를 페이지 테이블 캐시인 TLB(Translation Lookaside Buffer)에서 교체하지 않음을 의미한다.
  - CR4 레지스터의 PGE 비트를 1로 설정할 때만 유효하다.
  - 1로 설정하면 CR3 레지스터 교체 시에 해당 페이지를 TLB에서 교체하지 않으며, 
    0으로 설정하면 TLB에서 교체한다.
- **PS**
  - Page Size의 약자로 페이지 크기를 의미한다.
  - 1로 설정했을 때 CR4 레지스터의 PAE 비트가 0이면 4MB 페이지를 나타내며,
    PAE 비트가 1이면 2MB 페이지를 나타낸다.
  - 0으로 설정하면 4KB 페이지를 나타낸다.
- **D**
  - Dirty의 약자로 관련된 페이지에 쓰기가 수행되었음을 의미한다.
  - A 비트와 마찬가지로 프로세서가 페이지를 감시하여 해당 비트를 설정한다.
  - 1로 설정되면 쓰기가 수행되었음을 나타내고, 0으로 설정되면 쓰기가 수행되지 않았음을 나타낸다.

<hr>

필드가 복잡하지만,
**무작정 필드 값을 고민하기보다 목적을 정리하고 그에 맞게 설정하는 것이 좋다.**

우리 OS를 실행하는 데 필요한 페이지의 역할은 다음과 같다.

- **선형 주소와 물리 주소를 1:1로 매핑하여 직관적인 어드레스 변환 수행**
- **2MB 페이지를 사용하여 최대 64GB의 물리 메모리를 매핑해야 한다.**
- **물리 메모리 전체 영역에 대해 캐시를 활성화하여 수행 속도를 향상시켜야 한다.**

<hr>

다음절에서 위 목표를 바탕으로 페이지 테이블을 만들어 본다.