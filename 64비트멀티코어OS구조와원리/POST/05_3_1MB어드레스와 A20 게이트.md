# 1MB 어드레스와 A20 게이트

A20은 어드레스 라인의 번호를 의미 하지만, 실제로는 이름 이상으로 중요한 내용이 담겨 있다.

A20 게이트를 간단히 살펴본 뒤 시스템 포트와 BIOS 서비스를 이용하여 A20 게이트를 활성화해보자.

<hr>

## A20 게이트의 의미와 용도

A20 게이트에서 A20의 의미는 어드레스의 20번째 비트를 뜻하며,
A20의 역할은 어드레스 20번째 비트를 활성화하거나 비활성화 하여,
XT PC의 어드레스 계산 방식과 호환성을 유지시킨다.

> A20 게이트가 비활성화되면 어드레스 라인의 20번째(1M의 위치)가 항상 0으로 고정되므로 
> 선형 주소가 0x10FFEF가 되더라도 0xFFEF로 처리할 수 있다.

AT PC는 부팅 과정을 완료하고 나서 A20 게이트를 무조건 0으로 설정하여 XT PC와 호환성을 유지했으며,
A20 게이트를 활성화 했을 때만 20번째 어드레스 비트가 정상적으로 동작하게 했다.

이것이 이전 절에서 보았던 PC에서 1MB ~ 6MB 영역을 0으로 초기화 할때 문제를 일으킨 것이다.

<hr>

다음 그림은 A20 게이트의 비활성화에 따른 선형 주소의 변화에 대해서 나타낸 것이다.

[![A20 게이트 비활성화에 따른 선형 주소의 변화에 대한 이미지 검색결과](http://cfs15.tistory.com/image/8/tistory/2008/12/28/17/05/49573356ef5e6)](https://www.google.com/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&ved=2ahUKEwiP_9TlvaXjAhW0y4sBHQuSCU4QjRx6BAgBEAU&url=https%3A%2F%2Fkkamagui.tistory.com%2F619&psig=AOvVaw3lmwwuynJh-anMMeErbsdl&ust=1562680806175751)



A20 게이트가 비활성화된 상태에서는 어드레스 라인의 20번째 비트가 항상 0으로 설정되므로
홀수 MB에는 접근할 수 없다.

최초 부팅된 이후의 상태는 A20 게이트가 비활성화 된 상태이므로 1MB ~ 4MB 까지의 어드레스를 초기화 하면 홀수 MB 영역을 제외한 0 ~ 1MB 와 2MB ~ 3MB 영역을 초기화 하게 된다.

하지만, 0 ~ 1MB 영역은 BIOS와 보호 모드 커널 영역으로 사용하고 있으므로 현재 커널이 수행 중인 부분이 초기화하게 되어 문제가 생긴다.



다음 그림은 A20 게이트 비활성화에 따라 접근 가능한 메모리 공간의 변화를 나타낸 것이다.

[![A20 게이트 비활성화에 따른 선형 주소의 변화에 대한 이미지 검색결과](http://cfs13.tistory.com/image/27/tistory/2008/12/28/17/41/49573bb2acd45)](https://www.google.com/url?sa=i&rct=j&q=&esrc=s&source=images&cd=&cad=rja&uact=8&ved=2ahUKEwjMzZOrvqXjAhVcIqYKHfdlBXsQjRx6BAgBEAU&url=%2Furl%3Fsa%3Di%26rct%3Dj%26q%3D%26esrc%3Ds%26source%3Dimages%26cd%3D%26ved%3D%26url%3Dhttps%3A%2F%2Fkkamagui.tistory.com%2F619%26psig%3DAOvVaw3lmwwuynJh-anMMeErbsdl%26ust%3D1562680806175751&psig=AOvVaw3lmwwuynJh-anMMeErbsdl&ust=1562680806175751)

> 문제 없이 실행되는 경우는
> 간혹 최신 BIOS 중에서 A20 게이트를 사용하지 않거나 기본 값으로 1로 설정하기 때문이다.



<hr>



## A20 게이트 활성화 방법

A20 게이트를 활성화하는 방법은 크게 세 가지가 있다.

- **키보드 컨트롤러(Keboard Controller)로 활성화 하는 방법**

  키보드 컨트롤러로 활성화하는 방법은 AT PC의 초창기 시절부터 사용되던 방법이다.
  과거 AT PC는 키보드 컨트롤러에 A20 게이트를 연결하여 키보드 컨트롤러를 통해 제어하도록 했다.

  컨트롤러를 통하는 방법은 속도가 느리고 소스 코드가 복잡하지만,
  PS / 2 방식의 키보드 / 마우스를 지원하는 PC라면 어디서나 사용 가능하다는 장점이 있다.

- **시스템 컨트롤 포트(System Control Port)로 활성화 하는 방법**

  시스템 제어에 관련된 I / O 포트를 통해 A20 게이트를 활성화 하는 방법이다.
  시스템 포트를 통한 방법은 키보드 컨트롤러를 통하는 것보다 속도가 빠르고 소스 코드가 간략하다는 장점이 있다.

- **BIOS 서비스로 활성화하는 방법**

  486 프로세서를 지원하는 BIOS에서 처음 도입되었으며,
  BIOS 서비스 중에 시스템에 관련된 서비스를 통해 A20 게이트를 활성화 하는 방법이다.

  > PC의 전반적인 정보를 관리하는 BIOS의 서비스를 사용하므로 
  > 세 가지 방법 중에 가장 확실한 방법이라고 할 수 있다.



> PC에 있는 프로세서의 코어 수가 2개 이상 (듀얼 코어) 이거나 64비트를 지원하는 프로세서라면
> 위의 세 가지 방법 중 최소 두 가지는 지원할 것이다.
> 같은 기능을 하는 코드를 굳이 세 가지나 구현할 필요는 없으므로 BIOS 서비스를 사용하여 A20 게이트를 활성화 할 예정이다.



<hr>

### 시스템 컨트롤 포트로 A20 게이트 활성화하기

시스템 컨트롤 포트는 I/O 포트 어드레스의 0x92에 위치하며, 
A20 게이트부터 하드 디스크 LED 까지 여러 시스템 옵션을 담당한다.

다음 표는 시스템 컨트롤 포트의 각 비트와 그 의미를 정리한 것이다.

![image](https://user-images.githubusercontent.com/34773827/60817913-8ac94e80-a1d7-11e9-8ef8-841e977d66a0.png)

우리의 목적은 A20 게이트를 활성화하는 것이므로 시스템 컨트롤 비트 1만 1로 설정한다.

시스템 컨트롤 포트는 I/O 포트에 있으므로, 이에 접근하려면 별도의 명령어를 사용해야한다.

> x86 프로세서는 I/O 포트에 접근하는 in / out 명령어를 제공한다.

< 시스템 컨트롤 포트를 통해 A20 게이트를 활성화 하는 코드 >

```assembly
in al, 0x92		; 시스템 컨트롤 포트(0x92)에서 1바이트를 읽어 AL 레지스터에 저장

or al, 0x02		; 읽은 값에 A20 게이트 비트(비트 1)를 1로 설정
and al, 0xFE	; 시스템 리셋 방지를 위해 0xFE와 AND 연산하여 비트 0를 0으로 설정

out 0x92, al	; 시스템 컨트롤 포트(0x92)에 변경된 값을 1바이트 설정             
```



<hr>

### BIOS 서비스로 A20 게이트 활성화 방법

BIOS 서비스로 A20 게이트를 활성화 하는 방법은
A20 게이트 관련 설정 값을 AX 레지스터에 넣고 나서 
A20 게이트를 활성화 하는 BIOS의 시스템 서비스(인터럽트 벡터 0x15)를 호출하는 것이다.

BIOS 서비스 중에서 A20 게이트 관련 기능은 BIOS의 시스템 서비스에 포함되어 있으며,
시스템 서비스는 인터럽트 벡터 테이블의 0x15에 있다.

< BIOS의 시스템 서비스 중 A20 게이트 관련 기능 >

![image](https://user-images.githubusercontent.com/34773827/60882882-b99cfe80-a283-11e9-8ad5-31a304e8cfff.png)



다음은 BIOS 서비스를 호출하여 A20 게이트를 활성화하는 코드이다. 

```assembly
mov ax, 0x2401		; A20 게이트 활성화 서비스 설정
int 0x15			; BIOS 인터럽트 서비스 호출

jc .A20GATERROR		; A20 게이트 활성화가 성공했는지 확인
					; A20 게이트 활성화가 실패이면 EFLAGS 레지스터의 CF 비트가 1로 설정되므로,
					; 이를 검사하여 에러를 처리한다.
jmp .A20GATESUCCESS	

.A20GATEERROR:

 	...처리...
 
.A20GATESUCCESS:

 	...처리...
 
```

<hr>

여기까지 A20 게이트를 활성화 하는 방법과 코드까지 살펴보았다.

